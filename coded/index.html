<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Coded - A lightweight code playground for quick prototyping">
    <title>Coded - Code Playground</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet">

    <style>
        /* Reset and base styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Local Cartridge font */
        @font-face {
            font-family: "Cartridge Regular";
            src: url('../assets/Cartridge-Regular.woff2') format('woff2'),
                 url('../assets/Cartridge-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --font-main: "Manrope", sans-serif;
            --font-mono: "JetBrains Mono", monospace;
            --font-logo: "Cartridge Regular", sans-serif;
            --bg-color: #191970;
            --text-color: #ffffff;
            --accent-color: #64ffda;
            --secondary-color: #b8c4f5;
            --editor-bg: #1a1a3e;
            --editor-border: #2d2d5f;
            --preview-bg: #ffffff;
            --button-bg: #64ffda;
            --button-text: #191970;
            --button-hover: #52e8c8;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            padding: 1rem 2rem;
            background: var(--editor-bg);
            border-bottom: 2px solid var(--editor-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-family: var(--font-logo);
            font-size: 1.75rem;
            font-weight: 400;
            letter-spacing: 0.02em;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Auto-run toggle */
        .auto-run-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .auto-run-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-color);
        }

        .auto-run-toggle label {
            cursor: pointer;
            user-select: none;
        }

        /* Snippets dropdown */
        .snippets-dropdown {
            position: relative;
        }

        .snippets-button {
            background: none;
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-main);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            height: 40px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .snippets-button:hover {
            background: var(--secondary-color);
            color: var(--bg-color);
        }

        /* More options menu */
        .more-options-dropdown {
            position: relative;
        }

        .more-options-button {
            background: none;
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-main);
            font-size: 1.2rem;
            font-weight: 500;
            transition: all 0.3s ease;
            height: 40px;
            width: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .more-options-button:hover {
            background: var(--secondary-color);
            color: var(--bg-color);
        }

        .more-options-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--editor-bg);
            border: 2px solid var(--editor-border);
            border-radius: 4px;
            min-width: 200px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .more-options-menu.active {
            display: block;
        }

        .more-option-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--editor-border);
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .more-option-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .more-option-item:last-child {
            border-bottom: none;
        }

        .snippets-menu {
            display: none;
            background: var(--editor-bg);
            border: 2px solid var(--editor-border);
            border-radius: 8px;
            min-width: 400px;
            max-width: 500px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .snippets-menu-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--editor-border);
            font-weight: 500;
            color: var(--accent-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .snippet-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--editor-border);
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .snippet-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .snippet-item:last-child {
            border-bottom: none;
        }

        .snippet-name {
            flex: 1;
        }

        .snippet-actions {
            display: flex;
            gap: 0.5rem;
        }

        .snippet-delete {
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .snippet-delete:hover {
            opacity: 1;
            color: #ff6b6b;
        }

        .empty-state {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--secondary-color);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Library items */
        .library-item {
            padding: 0.75rem;
            border: 1px solid var(--editor-border);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .library-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-color);
        }

        .library-item.added {
            background: rgba(100, 255, 218, 0.1);
            border-color: var(--accent-color);
            cursor: default;
        }

        .library-name {
            font-weight: 500;
        }

        .library-version {
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-left: 0.5rem;
        }

        .library-remove {
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .library-remove:hover {
            opacity: 1;
            color: #ff6b6b;
        }

        /* All header buttons - consistent sizing */
        .run-button,
        .clear-button,
        .export-button {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-main);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Run button */
        .run-button {
            background: var(--button-bg);
            color: var(--button-text);
            border: 2px solid var(--button-bg);
            padding: 0.5rem 1.5rem;
        }

        .run-button:hover {
            background: var(--button-hover);
            border-color: var(--button-hover);
            transform: translateY(-2px);
        }

        /* Clear button */
        .clear-button {
            background: none;
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
        }

        .clear-button:hover {
            background: var(--secondary-color);
            color: var(--bg-color);
        }

        /* Export button */
        .export-button {
            background: none;
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
        }

        .export-button:hover {
            background: var(--accent-color);
            color: var(--bg-color);
        }

        /* Main container */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Resizer */
        .resizer {
            background: var(--editor-border);
            cursor: row-resize;
            height: 4px;
            position: relative;
            z-index: 10;
            transition: background 0.2s;
        }

        /* Increase hit area for easier dragging */
        .resizer::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 0;
            right: 0;
            bottom: -4px;
            cursor: row-resize;
        }

        .resizer:hover {
            background: var(--accent-color);
        }

        .resizer.resizing {
            background: var(--accent-color);
        }

        /* Prevent text selection during resize */
        body.resizing {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }

        /* Prevent iframe from intercepting mouse events during resize */
        body.resizing #preview {
            pointer-events: none;
        }

        /* Editors section */
        .editors {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--editor-border);
            border-bottom: 2px solid var(--editor-border);
            height: 50%;
            transition: grid-template-columns 0.3s ease;
        }

        /* Disable height transition during manual resize for smooth dragging */
        body.resizing .editors {
            transition: none;
        }

        /* Vertical layout */
        .editors.vertical-layout {
            grid-template-columns: 1fr;
            height: 60%;
        }

        /* Share mode - show more preview */
        body.share-mode .editors {
            height: 30%;
        }

        .editor-panel {
            background: var(--editor-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }

        .editor-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: row;
            min-height: 0;
        }

        .line-numbers {
            background: var(--editor-bg);
            color: var(--secondary-color);
            padding: 1rem 0.5rem 1rem 1rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
            text-align: right;
            user-select: none;
            opacity: 0.5;
            border-right: 1px solid var(--editor-border);
            overflow: hidden;
            min-width: 3rem;
            white-space: pre;
        }

        .editor-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }

        .editor-header {
            padding: 0.75rem 1rem;
            background: var(--editor-bg);
            border-bottom: 1px solid var(--editor-border);
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--accent-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .panel-settings-button {
            background: none;
            border: 1px solid var(--editor-border);
            color: var(--secondary-color);
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            opacity: 0.7;
            position: relative;
        }

        .panel-settings-button:hover {
            opacity: 1;
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .panel-settings-menu {
            display: none;
            position: absolute;
            top: calc(100% + 0.25rem);
            right: 0;
            background: var(--editor-bg);
            border: 2px solid var(--editor-border);
            border-radius: 4px;
            min-width: 180px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .panel-settings-menu.active {
            display: block;
        }

        .editor {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
            background: transparent;
            color: rgba(255, 255, 255, 0.03);
            caret-color: var(--accent-color);
            border: none;
            resize: none;
            outline: none;
            overflow: auto;
            overflow-x: auto;
            overflow-y: scroll;
            scrollbar-gutter: stable;
            tab-size: 2;
            z-index: 2;
            -webkit-text-fill-color: rgba(255, 255, 255, 0.03);
            white-space: pre;
            word-wrap: normal;
            box-sizing: border-box;
            margin: 0;
            padding-top: 1rem;
            padding-bottom: 1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            letter-spacing: 0;
            word-spacing: 0;
            text-indent: 0;
            text-rendering: geometricPrecision;
            -webkit-font-smoothing: subpixel-antialiased;
            -moz-osx-font-smoothing: auto;
            font-variant: normal;
            font-feature-settings: normal;
            font-kerning: none;
            transform: translateZ(0);
        }

        .editor.wrap-enabled {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .editor::placeholder {
            color: var(--secondary-color);
            opacity: 0.5;
            -webkit-text-fill-color: var(--secondary-color);
        }

        /* Tab trap indicator */
        .editor-content::after {
            content: "Tab to indent ‚Ä¢ Esc to exit";
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            font-size: 0.75rem;
            color: var(--secondary-color);
            background: var(--editor-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 3;
        }

        .editor-content.tab-trapped::after {
            opacity: 0.7;
        }

        .editor-highlight {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 1rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
            overflow: hidden;
            overflow-x: hidden;
            overflow-y: hidden;
            pointer-events: none;
            z-index: 1;
            white-space: pre;
            word-wrap: normal;
            box-sizing: border-box;
            margin: 0;
            padding-top: 1rem;
            padding-bottom: 1rem;
            padding-left: 1rem;
            padding-right: calc(1rem + 8px);
            letter-spacing: 0;
            word-spacing: 0;
            text-indent: 0;
            text-rendering: geometricPrecision;
            -webkit-font-smoothing: subpixel-antialiased;
            -moz-osx-font-smoothing: auto;
            font-variant: normal;
            font-feature-settings: normal;
            font-kerning: none;
            transform: translateZ(0);
        }

        .editor-highlight.wrap-enabled {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .editor-highlight pre {
            margin: 0 !important;
            padding: 0 !important;
            background: transparent !important;
            white-space: inherit;
            word-wrap: inherit;
            display: block;
            line-height: inherit;
            font-size: inherit;
            font-family: inherit;
            border: none;
        }

        .editor-highlight code {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.5;
            background: transparent !important;
            white-space: inherit;
            word-wrap: inherit;
            letter-spacing: 0;
            margin: 0 !important;
            padding: 0 !important;
            display: block;
            border: none;
            vertical-align: baseline;
        }

        /* Override any Prism theme styles that might add spacing */
        .editor-highlight pre[class*="language-"],
        .editor-highlight code[class*="language-"],
        .editor-highlight .highlight-content {
            margin: 0 !important;
            padding: 0 !important;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            text-shadow: none !important;
            border-radius: 0 !important;
            font-family: var(--font-mono) !important;
            font-size: 0.9rem !important;
            line-height: 1.5 !important;
            letter-spacing: 0 !important;
            word-spacing: 0 !important;
            text-indent: 0 !important;
            font-variant: normal !important;
            font-feature-settings: normal !important;
            font-kerning: none !important;
            display: block;
        }

        .editor::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .editor::-webkit-scrollbar-track {
            background: var(--editor-bg);
        }

        .editor::-webkit-scrollbar-thumb {
            background: var(--editor-border);
            border-radius: 4px;
        }

        .editor::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        /* Preview section */
        .preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--editor-bg);
        }

        /* Optimize resize performance */
        body.resizing .editors,
        body.resizing .preview-section {
            will-change: height;
        }

        .preview-header {
            padding: 0.75rem 1rem;
            background: var(--editor-bg);
            border-bottom: 1px solid var(--editor-border);
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--accent-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-actions {
            display: flex;
            gap: 0.5rem;
        }

        .preview-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        #preview {
            flex: 1;
            width: 100%;
            border: none;
            background: var(--preview-bg);
            transition: height 0.3s ease;
        }

        /* Console panel */
        .console-panel {
            display: none;
            flex-direction: column;
            height: 200px;
            background: var(--editor-bg);
            border-top: 2px solid var(--editor-border);
        }

        .console-panel.active {
            display: flex;
        }

        .console-header {
            padding: 0.5rem 1rem;
            background: var(--editor-bg);
            border-bottom: 1px solid var(--editor-border);
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-clear {
            background: none;
            border: 1px solid var(--editor-border);
            color: var(--secondary-color);
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .console-clear:hover {
            opacity: 1;
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .console-output {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .console-output::-webkit-scrollbar {
            width: 8px;
        }

        .console-output::-webkit-scrollbar-track {
            background: var(--editor-bg);
        }

        .console-output::-webkit-scrollbar-thumb {
            background: var(--editor-border);
            border-radius: 4px;
        }

        .console-output::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color);
        }

        .console-message {
            padding: 0.25rem 0.5rem;
            margin-bottom: 2px;
            border-left: 3px solid transparent;
            word-wrap: break-word;
        }

        .console-message.log {
            color: var(--text-color);
            border-left-color: var(--secondary-color);
        }

        .console-message.warn {
            color: #ffa500;
            border-left-color: #ffa500;
            background: rgba(255, 165, 0, 0.1);
        }

        .console-message.error {
            color: #ff6b6b;
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .console-message.info {
            color: #64ffda;
            border-left-color: #64ffda;
        }

        /* Tablet responsive */
        @media (max-width: 1024px) {
            body {
                /* Fix for mobile/tablet browsers where 100vh includes browser chrome */
                height: 100dvh; /* Dynamic viewport height */
                min-height: -webkit-fill-available;
            }

            .editors {
                grid-template-columns: 1fr;
                height: 60%;
            }

            header {
                padding: 0.75rem 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .header-actions {
                gap: 0.5rem;
            }

            .run-button {
                padding: 0.5rem 1.5rem;
            }
        }

        /* Share mode banner */
        .share-mode-banner {
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0.75rem 2rem;
            color: white;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .share-mode-banner.active {
            display: flex;
        }

        .share-mode-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .share-mode-actions {
            display: flex;
            gap: 0.75rem;
        }

        .share-mode-button {
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-main);
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
        }

        .share-mode-button.primary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
        }

        .share-mode-button.primary:hover {
            background: white;
            transform: translateY(-1px);
        }

        .share-mode-button.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .share-mode-button.secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Mobile - hide for now */
        @media (max-width: 768px) {
            body::before {
                content: "Coded is only available on desktop and tablet devices.";
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                padding: 2rem;
                background: var(--editor-bg);
                border: 2px solid var(--editor-border);
                border-radius: 8px;
                z-index: 9999;
            }

            .container, header {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Share Mode Banner -->
    <div class="share-mode-banner" id="shareModeBanner" role="status" aria-live="polite">
        <div class="share-mode-info">
            <span style="font-size: 1.2rem;">üîó</span>
            <span><strong>Viewing shared code</strong> ‚Äî Make your own edits and share them!</span>
        </div>
        <div class="share-mode-actions">
            <button class="share-mode-button primary" id="updateShareBtn">Update Share Link</button>
            <button class="share-mode-button secondary" id="startFreshBtn">Start Fresh</button>
        </div>
    </div>

    <header>
        <h1>&lt;/Coded&gt;</h1>
        <div class="header-actions">
            <div class="auto-run-toggle">
                <input type="checkbox" id="autoRunToggle" />
                <label for="autoRunToggle">Auto-run</label>
            </div>
            <button class="run-button" id="runBtn">Run Code</button>
            <div class="more-options-dropdown">
                <button class="more-options-button" id="moreOptionsBtn" aria-label="More options">
                    ‚ãØ
                </button>
                <div class="more-options-menu" id="moreOptionsMenu">
                    <div class="more-option-item" id="settingsBtn">
                        ‚öôÔ∏è Settings
                    </div>
                    <div class="more-option-item" id="saveSnippetMenuBtn">
                        üíæ Save Snippet
                    </div>
                    <div class="more-option-item" id="snippetsMenuBtn">
                        üìÇ Load Snippet
                    </div>
                    <div class="more-option-item" id="shareBtn">
                        üîó Share Link
                    </div>
                    <div class="more-option-item" id="exportBtn">
                        üì• Export HTML
                    </div>
                    <div class="more-option-item" id="clearBtn">
                        üóëÔ∏è Clear All
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Snippets Modal -->
    <div class="snippets-menu" id="snippetsMenu" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none;">
        <div class="snippets-menu-header">
            <span>Load Snippet</span>
            <span style="cursor: pointer; opacity: 0.7;" id="closeSnippetsBtn">‚úï</span>
        </div>
        <div id="snippetsList"></div>
    </div>

    <!-- Libraries Modal -->
    <div class="snippets-menu" id="librariesMenu" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none; max-height: 600px;">
        <div class="snippets-menu-header">
            <span>Add External Libraries</span>
            <span style="cursor: pointer; opacity: 0.7;" id="closeLibrariesBtn">‚úï</span>
        </div>
        <div style="padding: 1rem; border-bottom: 1px solid var(--editor-border);">
            <div style="margin-bottom: 1rem;">
                <strong style="display: block; margin-bottom: 0.5rem; color: var(--accent-color);">Popular Libraries</strong>
                <div id="popularLibraries"></div>
            </div>
            <div>
                <strong style="display: block; margin-bottom: 0.5rem; color: var(--accent-color);">Custom CDN</strong>
                <input type="text" id="customCdnInput" placeholder="Paste CDN URL..." style="width: 100%; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--editor-border); border-radius: 4px; color: var(--text-color); font-family: var(--font-main); font-size: 0.9rem; margin-bottom: 0.5rem;">
                <button id="addCustomCdnBtn" style="width: 100%; padding: 0.5rem; background: var(--accent-color); color: var(--bg-color); border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Add Custom CDN</button>
            </div>
        </div>
        <div style="padding: 1rem;">
            <strong style="display: block; margin-bottom: 0.5rem; color: var(--accent-color);">Added Libraries</strong>
            <div id="addedLibrariesList" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="snippets-menu" id="settingsMenu" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none; max-width: 500px;">
        <div class="snippets-menu-header">
            <span>Settings</span>
            <span style="cursor: pointer; opacity: 0.7;" id="closeSettingsBtn">‚úï</span>
        </div>
        <div style="padding: 1.5rem;">
            <!-- Font Size -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 500;">Editor Font Size</label>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <input type="range" id="fontSizeSlider" min="12" max="20" value="14" step="1" style="flex: 1; accent-color: var(--accent-color);">
                    <span id="fontSizeValue" style="color: var(--secondary-color); min-width: 3rem; text-align: right;">14px</span>
                </div>
            </div>

            <!-- Layout Toggle -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 500;">Editor Layout</label>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="layout-toggle-btn active" id="layoutHorizontalBtn" style="flex: 1; padding: 0.75rem; background: var(--accent-color); color: var(--bg-color); border: 2px solid var(--accent-color); border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                        Horizontal
                    </button>
                    <button class="layout-toggle-btn" id="layoutVerticalBtn" style="flex: 1; padding: 0.75rem; background: none; color: var(--secondary-color); border: 2px solid var(--editor-border); border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                        Vertical
                    </button>
                </div>
            </div>

            <!-- Theme (future) -->
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 500;">Theme</label>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="theme-toggle-btn active" style="flex: 1; padding: 0.75rem; background: var(--accent-color); color: var(--bg-color); border: 2px solid var(--accent-color); border-radius: 4px; cursor: pointer; font-weight: 500;">
                        Dark
                    </button>
                    <button class="theme-toggle-btn" disabled style="flex: 1; padding: 0.75rem; background: none; color: var(--secondary-color); border: 2px solid var(--editor-border); border-radius: 4px; opacity: 0.5; font-weight: 500;">
                        Light (Soon)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="snippetsOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1999;"></div>

    <!-- Find/Replace Panel -->
    <div id="findReplacePanel" style="display: none; position: fixed; top: 80px; right: 20px; background: var(--editor-bg); border: 2px solid var(--editor-border); border-radius: 8px; padding: 1rem; z-index: 3000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); min-width: 350px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <span style="font-weight: 500; color: var(--accent-color);">Find & Replace</span>
            <span id="closeFindReplaceBtn" style="cursor: pointer; opacity: 0.7; font-size: 1.2rem; color: var(--secondary-color);">‚úï</span>
        </div>

        <div style="margin-bottom: 0.5rem;">
            <input type="text" id="findInput" placeholder="Find..." style="width: 100%; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--editor-border); border-radius: 4px; color: var(--text-color); font-family: var(--font-main); font-size: 0.9rem;">
        </div>

        <div style="margin-bottom: 0.75rem;">
            <input type="text" id="replaceInput" placeholder="Replace with..." style="width: 100%; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--editor-border); border-radius: 4px; color: var(--text-color); font-family: var(--font-main); font-size: 0.9rem;">
        </div>

        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button id="findPrevBtn" style="flex: 1; min-width: 70px; padding: 0.5rem; background: none; border: 1px solid var(--editor-border); color: var(--secondary-color); border-radius: 4px; cursor: pointer; font-size: 0.85rem;">‚Üê Prev</button>
            <button id="findNextBtn" style="flex: 1; min-width: 70px; padding: 0.5rem; background: var(--accent-color); border: 1px solid var(--accent-color); color: var(--bg-color); border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">Next ‚Üí</button>
            <button id="replaceBtn" style="flex: 1; min-width: 70px; padding: 0.5rem; background: none; border: 1px solid var(--editor-border); color: var(--secondary-color); border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Replace</button>
            <button id="replaceAllBtn" style="flex: 1; min-width: 70px; padding: 0.5rem; background: none; border: 1px solid var(--editor-border); color: var(--secondary-color); border-radius: 4px; cursor: pointer; font-size: 0.85rem;">All</button>
        </div>

        <div style="margin-top: 0.75rem; font-size: 0.8rem; color: var(--secondary-color); opacity: 0.7;">
            <span id="findResultsText">Press Enter or click Next</span>
        </div>
    </div>

    <div class="container">
        <!-- Editors Section -->
        <div class="editors">
            <div class="editor-panel">
                <div class="editor-header">
                    <span>HTML</span>
                    <button class="panel-settings-button" id="htmlSettingsBtn" aria-label="HTML panel settings">‚öô</button>
                    <div class="panel-settings-menu" id="htmlSettingsMenu">
                        <div class="more-option-item" id="htmlLibrariesBtn">
                            üìö Add Libraries
                        </div>
                        <div class="more-option-item" id="htmlWrapToggle">
                            ‚Ü©Ô∏è Word Wrap: <span id="htmlWrapStatus">Off</span>
                        </div>
                    </div>
                </div>
                <div class="editor-container">
                    <div class="line-numbers" id="htmlLineNumbers">1</div>
                    <div class="editor-content">
                        <div class="editor-highlight" id="htmlHighlight"></div>
                        <textarea
                            class="editor"
                            id="htmlEditor"
                            placeholder="<!-- Enter your HTML here -->"
                            spellcheck="false"
                            aria-label="HTML code editor. Press Tab to indent, Shift+Tab to outdent, Escape to exit and restore normal tab navigation."
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="editor-panel">
                <div class="editor-header">
                    <span>CSS</span>
                    <button class="panel-settings-button" id="cssSettingsBtn" aria-label="CSS panel settings">‚öô</button>
                    <div class="panel-settings-menu" id="cssSettingsMenu">
                        <div class="more-option-item" id="cssLibrariesBtn">
                            üìö Add Libraries
                        </div>
                        <div class="more-option-item" id="cssWrapToggle">
                            ‚Ü©Ô∏è Word Wrap: <span id="cssWrapStatus">Off</span>
                        </div>
                        <div class="more-option-item" id="cssResetBtn">
                            üîÑ CSS Reset: <span id="cssResetStatus">None</span>
                        </div>
                    </div>
                </div>
                <div class="editor-container">
                    <div class="line-numbers" id="cssLineNumbers">1</div>
                    <div class="editor-content">
                        <div class="editor-highlight" id="cssHighlight"></div>
                        <textarea
                            class="editor"
                            id="cssEditor"
                            placeholder="/* Enter your CSS here */"
                            spellcheck="false"
                            aria-label="CSS code editor. Press Tab to indent, Shift+Tab to outdent, Escape to exit and restore normal tab navigation."
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="editor-panel">
                <div class="editor-header">
                    <span>JavaScript</span>
                    <button class="panel-settings-button" id="jsSettingsBtn" aria-label="JavaScript panel settings">‚öô</button>
                    <div class="panel-settings-menu" id="jsSettingsMenu">
                        <div class="more-option-item" id="jsLibrariesBtn">
                            üìö Add Libraries
                        </div>
                        <div class="more-option-item" id="jsWrapToggle">
                            ‚Ü©Ô∏è Word Wrap: <span id="jsWrapStatus">Off</span>
                        </div>
                    </div>
                </div>
                <div class="editor-container">
                    <div class="line-numbers" id="jsLineNumbers">1</div>
                    <div class="editor-content">
                        <div class="editor-highlight" id="jsHighlight"></div>
                        <textarea
                            class="editor"
                            id="jsEditor"
                            placeholder="// Enter your JavaScript here"
                            spellcheck="false"
                            aria-label="JavaScript code editor. Press Tab to indent, Shift+Tab to outdent, Escape to exit and restore normal tab navigation."
                        ></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resizer -->
        <div class="resizer" id="resizer"></div>

        <!-- Preview Section -->
        <div class="preview-section">
            <div class="preview-header">
                <span>Preview</span>
                <div class="preview-actions">
                    <button class="panel-settings-button" id="toggleConsoleBtn" title="Toggle Console">
                        Console
                    </button>
                </div>
            </div>
            <div class="preview-container">
                <iframe id="preview" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
                <div class="console-panel" id="consolePanel">
                    <div class="console-header">
                        <span>Console</span>
                        <button class="console-clear" id="clearConsoleBtn" title="Clear console">Clear</button>
                    </div>
                    <div class="console-output" id="consoleOutput"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prism.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

    <script>
        // Get DOM elements
        const htmlEditor = document.getElementById('htmlEditor');
        const cssEditor = document.getElementById('cssEditor');
        const jsEditor = document.getElementById('jsEditor');
        const htmlHighlight = document.getElementById('htmlHighlight');
        const cssHighlight = document.getElementById('cssHighlight');
        const jsHighlight = document.getElementById('jsHighlight');
        const htmlLineNumbers = document.getElementById('htmlLineNumbers');
        const cssLineNumbers = document.getElementById('cssLineNumbers');
        const jsLineNumbers = document.getElementById('jsLineNumbers');
        const preview = document.getElementById('preview');
        const runBtn = document.getElementById('runBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');
        const shareBtn = document.getElementById('shareBtn');
        const autoRunToggle = document.getElementById('autoRunToggle');
        const moreOptionsBtn = document.getElementById('moreOptionsBtn');
        const moreOptionsMenu = document.getElementById('moreOptionsMenu');
        const saveSnippetMenuBtn = document.getElementById('saveSnippetMenuBtn');
        const snippetsMenuBtn = document.getElementById('snippetsMenuBtn');

        // Panel-specific settings
        const htmlSettingsBtn = document.getElementById('htmlSettingsBtn');
        const htmlSettingsMenu = document.getElementById('htmlSettingsMenu');
        const htmlLibrariesBtn = document.getElementById('htmlLibrariesBtn');
        const htmlWrapToggle = document.getElementById('htmlWrapToggle');
        const htmlWrapStatus = document.getElementById('htmlWrapStatus');

        const cssSettingsBtn = document.getElementById('cssSettingsBtn');
        const cssSettingsMenu = document.getElementById('cssSettingsMenu');
        const cssLibrariesBtn = document.getElementById('cssLibrariesBtn');
        const cssWrapToggle = document.getElementById('cssWrapToggle');
        const cssWrapStatus = document.getElementById('cssWrapStatus');
        const cssResetBtn = document.getElementById('cssResetBtn');
        const cssResetStatus = document.getElementById('cssResetStatus');

        const jsSettingsBtn = document.getElementById('jsSettingsBtn');
        const jsSettingsMenu = document.getElementById('jsSettingsMenu');
        const jsLibrariesBtn = document.getElementById('jsLibrariesBtn');
        const jsWrapToggle = document.getElementById('jsWrapToggle');
        const jsWrapStatus = document.getElementById('jsWrapStatus');
        const snippetsMenu = document.getElementById('snippetsMenu');
        const librariesMenu = document.getElementById('librariesMenu');
        const snippetsOverlay = document.getElementById('snippetsOverlay');
        const closeSnippetsBtn = document.getElementById('closeSnippetsBtn');
        const closeLibrariesBtn = document.getElementById('closeLibrariesBtn');
        const snippetsList = document.getElementById('snippetsList');
        const popularLibraries = document.getElementById('popularLibraries');
        const addedLibrariesList = document.getElementById('addedLibrariesList');
        const customCdnInput = document.getElementById('customCdnInput');
        const addCustomCdnBtn = document.getElementById('addCustomCdnBtn');
        const resizer = document.getElementById('resizer');
        const editorsSection = document.querySelector('.editors');
        const previewSection = document.querySelector('.preview-section');
        const container = document.querySelector('.container');
        const shareModeBanner = document.getElementById('shareModeBanner');
        const updateShareBtn = document.getElementById('updateShareBtn');
        const startFreshBtn = document.getElementById('startFreshBtn');
        const toggleConsoleBtn = document.getElementById('toggleConsoleBtn');
        const consolePanel = document.getElementById('consolePanel');
        const consoleOutput = document.getElementById('consoleOutput');
        const clearConsoleBtn = document.getElementById('clearConsoleBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsMenu = document.getElementById('settingsMenu');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const layoutHorizontalBtn = document.getElementById('layoutHorizontalBtn');
        const layoutVerticalBtn = document.getElementById('layoutVerticalBtn');
        const findReplacePanel = document.getElementById('findReplacePanel');
        const closeFindReplaceBtn = document.getElementById('closeFindReplaceBtn');
        const findInput = document.getElementById('findInput');
        const replaceInput = document.getElementById('replaceInput');
        const findPrevBtn = document.getElementById('findPrevBtn');
        const findNextBtn = document.getElementById('findNextBtn');
        const replaceBtn = document.getElementById('replaceBtn');
        const replaceAllBtn = document.getElementById('replaceAllBtn');
        const findResultsText = document.getElementById('findResultsText');

        let autoRunEnabled = localStorage.getItem('coded-autorun') === 'true';
        let autoRunTimeout = null;
        let wordWrapEnabled = {
            html: localStorage.getItem('coded-wordwrap-html') !== null ? localStorage.getItem('coded-wordwrap-html') === 'true' : true,
            css: localStorage.getItem('coded-wordwrap-css') !== null ? localStorage.getItem('coded-wordwrap-css') === 'true' : true,
            js: localStorage.getItem('coded-wordwrap-js') !== null ? localStorage.getItem('coded-wordwrap-js') === 'true' : true
        };
        let cssResetType = localStorage.getItem('coded-css-reset') || 'none'; // 'none', 'normalize', 'reset'
        let isShareMode = false; // Track if we're in share mode

        // Debounced auto-run (waits 800ms after last keystroke)
        function debouncedAutoRun() {
            if (!autoRunEnabled) return;

            clearTimeout(autoRunTimeout);
            autoRunTimeout = setTimeout(() => {
                runCode();
            }, 800); // Wait 800ms after user stops typing
        }

        // Syntax highlighting with Prism
        function highlightEditor(editor, highlight, language) {
            const code = editor.value;
            if (code) {
                const highlighted = Prism.highlight(code, Prism.languages[language], language);
                // Use a simple div wrapper instead of pre/code to avoid spacing issues
                highlight.innerHTML = `<div class="highlight-content">${highlighted}</div>`;
            } else {
                highlight.innerHTML = '';
            }
            syncScroll(editor, highlight);
        }

        // Sync scroll between editor and highlight
        function syncScroll(editor, highlight) {
            highlight.scrollTop = editor.scrollTop;
            highlight.scrollLeft = editor.scrollLeft;
        }

        // Enhanced sync with requestAnimationFrame for better cursor positioning
        function syncScrollRaf(editor, highlight) {
            requestAnimationFrame(() => {
                highlight.scrollTop = editor.scrollTop;
                highlight.scrollLeft = editor.scrollLeft;
            });
        }

        // Update line numbers
        function updateLineNumbers(editor, lineNumbersElement) {
            const lines = editor.value.split('\n').length;
            const numbers = [];
            for (let i = 1; i <= lines; i++) {
                numbers.push(i);
            }
            lineNumbersElement.textContent = numbers.join('\n');

            // Sync scroll
            lineNumbersElement.scrollTop = editor.scrollTop;
        }

        // Sync line numbers scroll with editor
        function syncLineNumbersScroll(editor, lineNumbersElement) {
            lineNumbersElement.scrollTop = editor.scrollTop;
        }

        // Snippets management
        function getSnippets() {
            const snippets = localStorage.getItem('coded-snippets');
            return snippets ? JSON.parse(snippets) : [];
        }

        function saveSnippets(snippets) {
            localStorage.setItem('coded-snippets', JSON.stringify(snippets));
        }

        function saveCurrentSnippet() {
            // Check if there's any code to save
            const hasCode = htmlEditor.value.trim() || cssEditor.value.trim() || jsEditor.value.trim();
            if (!hasCode) {
                alert('Cannot save an empty snippet. Please add some code first!');
                return;
            }

            const name = prompt('Enter a name for this snippet:');
            if (!name || !name.trim()) {
                return;
            }

            const snippet = {
                id: Date.now(),
                name: name.trim(),
                html: htmlEditor.value,
                css: cssEditor.value,
                js: jsEditor.value,
                timestamp: new Date().toISOString()
            };

            const snippets = getSnippets();
            snippets.push(snippet);
            saveSnippets(snippets);

            // Show confirmation
            alert(`Snippet "${name.trim()}" saved!`);
            moreOptionsMenu.classList.remove('active');
        }

        function loadSnippet(id) {
            const snippets = getSnippets();
            const snippet = snippets.find(s => s.id === id);
            if (snippet) {
                htmlEditor.value = snippet.html;
                cssEditor.value = snippet.css;
                jsEditor.value = snippet.js;

                highlightEditor(htmlEditor, htmlHighlight, 'markup');
                highlightEditor(cssEditor, cssHighlight, 'css');
                highlightEditor(jsEditor, jsHighlight, 'javascript');

                saveCode();
                runCode();
                closeSnippetsModal();
            }
        }

        function deleteSnippet(id) {
            if (!confirm('Delete this snippet?')) return;
            const snippets = getSnippets().filter(s => s.id !== id);
            saveSnippets(snippets);
            renderSnippets();
        }

        function renderSnippets() {
            const snippets = getSnippets();
            if (snippets.length === 0) {
                snippetsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÇ</div>
                        <div class="empty-state-text">
                            No saved snippets yet.<br>
                            Save your first snippet from the menu!
                        </div>
                    </div>
                `;
                return;
            }

            snippetsList.innerHTML = snippets.map(snippet => `
                <div class="snippet-item">
                    <div class="snippet-name" onclick="loadSnippet(${snippet.id})">${snippet.name}</div>
                    <div class="snippet-actions">
                        <span class="snippet-delete" onclick="deleteSnippet(${snippet.id})">Delete</span>
                    </div>
                </div>
            `).join('');
        }

        // Make functions global for onclick handlers
        window.loadSnippet = loadSnippet;
        window.deleteSnippet = deleteSnippet;

        // Libraries management - organized by category
        const POPULAR_LIBS = {
            html: [
                { name: 'Marked (Markdown)', url: 'https://cdn.jsdelivr.net/npm/marked/marked.min.js', type: 'js' },
                { name: 'DOMPurify', url: 'https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js', type: 'js' },
                { name: 'Showdown (Markdown)', url: 'https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js', type: 'js' }
            ],
            css: [
                { name: 'Bootstrap CSS', url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css', type: 'css' },
                { name: 'Tailwind CSS', url: 'https://cdn.tailwindcss.com', type: 'js' },
                { name: 'Font Awesome', url: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css', type: 'css' },
                { name: 'Animate.css', url: 'https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css', type: 'css' },
                { name: 'Bulma CSS', url: 'https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css', type: 'css' },
                { name: 'Material Icons', url: 'https://fonts.googleapis.com/icon?family=Material+Icons', type: 'css' }
            ],
            js: [
                { name: 'jQuery', url: 'https://code.jquery.com/jquery-3.7.1.min.js', type: 'js' },
                { name: 'React', url: 'https://unpkg.com/react@18/umd/react.production.min.js', type: 'js' },
                { name: 'React DOM', url: 'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js', type: 'js' },
                { name: 'Vue 3', url: 'https://unpkg.com/vue@3/dist/vue.global.js', type: 'js' },
                { name: 'Bootstrap JS', url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js', type: 'js' },
                { name: 'Lodash', url: 'https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js', type: 'js' },
                { name: 'Axios', url: 'https://cdn.jsdelivr.net/npm/axios@1.6.2/dist/axios.min.js', type: 'js' },
                { name: 'GSAP', url: 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/gsap.min.js', type: 'js' },
                { name: 'Three.js', url: 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js', type: 'js' },
                { name: 'Chart.js', url: 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js', type: 'js' },
                { name: 'Moment.js', url: 'https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js', type: 'js' }
            ]
        };

        function getAddedLibraries() {
            const libs = localStorage.getItem('coded-libraries');
            return libs ? JSON.parse(libs) : [];
        }

        function saveAddedLibraries(libs) {
            localStorage.setItem('coded-libraries', JSON.stringify(libs));
        }

        function addLibrary(name, url, type) {
            const libs = getAddedLibraries();
            if (libs.find(l => l.url === url)) {
                alert('This library is already added!');
                return;
            }

            libs.push({ name, url, type });
            saveAddedLibraries(libs);
            renderLibraries(currentLibraryCategory);
            saveCode(); // Trigger save to update preview
        }

        let currentLibraryCategory = 'js'; // Default category for library modal

        function removeLibrary(url) {
            const libs = getAddedLibraries().filter(l => l.url !== url);
            saveAddedLibraries(libs);
            renderLibraries(currentLibraryCategory);
            saveCode();
        }

        function renderLibraries(category) {
            const added = getAddedLibraries();
            const categoryLibs = POPULAR_LIBS[category] || [];

            // Render popular libraries for this category
            popularLibraries.innerHTML = categoryLibs.map(lib => {
                const isAdded = added.find(l => l.url === lib.url);
                return `
                    <div class="library-item ${isAdded ? 'added' : ''}" onclick="${isAdded ? '' : `addLibrary('${lib.name}', '${lib.url}', '${lib.type}')`}">
                        <div>
                            <span class="library-name">${lib.name}</span>
                            <span class="library-version">${lib.type.toUpperCase()}</span>
                        </div>
                        ${isAdded ? '<span style="color: var(--accent-color);">‚úì Added</span>' : ''}
                    </div>
                `;
            }).join('');

            // Render added libraries (all, not filtered by category)
            if (added.length === 0) {
                addedLibrariesList.innerHTML = '<div class="empty-state-text" style="text-align: center; padding: 1rem; color: var(--secondary-color);">No libraries added yet</div>';
            } else {
                addedLibrariesList.innerHTML = added.map(lib => `
                    <div class="library-item">
                        <div>
                            <span class="library-name">${lib.name}</span>
                            <span class="library-version">${lib.type.toUpperCase()}</span>
                        </div>
                        <span class="library-remove" onclick="removeLibrary('${lib.url}')">Remove</span>
                    </div>
                `).join('');
            }
        }

        // Make functions global
        window.addLibrary = addLibrary;
        window.removeLibrary = removeLibrary;

        // Libraries modal
        function openLibrariesModal(category) {
            currentLibraryCategory = category; // Store current category

            const categoryNames = {
                html: 'HTML',
                css: 'CSS',
                js: 'JavaScript'
            };

            // Update modal title
            librariesMenu.querySelector('.snippets-menu-header span').textContent = `Add ${categoryNames[category]} Libraries`;

            librariesMenu.style.display = 'block';
            snippetsOverlay.style.display = 'block';
            renderLibraries(category);

            // Close panel menus
            htmlSettingsMenu.classList.remove('active');
            cssSettingsMenu.classList.remove('active');
            jsSettingsMenu.classList.remove('active');
        }

        function closeLibrariesModal() {
            librariesMenu.style.display = 'none';
            snippetsOverlay.style.display = 'none';
        }

        htmlLibrariesBtn.addEventListener('click', () => openLibrariesModal('html'));
        cssLibrariesBtn.addEventListener('click', () => openLibrariesModal('css'));
        jsLibrariesBtn.addEventListener('click', () => openLibrariesModal('js'));
        closeLibrariesBtn.addEventListener('click', closeLibrariesModal);

        // Add custom CDN
        addCustomCdnBtn.addEventListener('click', () => {
            const url = customCdnInput.value.trim();
            if (!url) {
                alert('Please enter a CDN URL');
                return;
            }

            const type = url.endsWith('.css') ? 'css' : 'js';
            const name = prompt('Enter a name for this library:');
            if (!name) return;

            addLibrary(name.trim(), url, type);
            customCdnInput.value = '';
        });

        // More options menu toggle
        moreOptionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            moreOptionsMenu.classList.toggle('active');
        });

        // Panel settings menu toggles
        htmlSettingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            htmlSettingsMenu.classList.toggle('active');
            cssSettingsMenu.classList.remove('active');
            jsSettingsMenu.classList.remove('active');
        });

        cssSettingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            cssSettingsMenu.classList.toggle('active');
            htmlSettingsMenu.classList.remove('active');
            jsSettingsMenu.classList.remove('active');
        });

        jsSettingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            jsSettingsMenu.classList.toggle('active');
            htmlSettingsMenu.classList.remove('active');
            cssSettingsMenu.classList.remove('active');
        });

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!moreOptionsMenu.contains(e.target) && e.target !== moreOptionsBtn) {
                moreOptionsMenu.classList.remove('active');
            }
            if (!htmlSettingsMenu.contains(e.target) && e.target !== htmlSettingsBtn) {
                htmlSettingsMenu.classList.remove('active');
            }
            if (!cssSettingsMenu.contains(e.target) && e.target !== cssSettingsBtn) {
                cssSettingsMenu.classList.remove('active');
            }
            if (!jsSettingsMenu.contains(e.target) && e.target !== jsSettingsBtn) {
                jsSettingsMenu.classList.remove('active');
            }
        });

        // Snippets modal toggle
        function openSnippetsModal() {
            snippetsMenu.style.display = 'block';
            snippetsOverlay.style.display = 'block';
            renderSnippets();
            moreOptionsMenu.classList.remove('active');
        }

        function closeSnippetsModal() {
            snippetsMenu.style.display = 'none';
            snippetsOverlay.style.display = 'none';
        }

        // Word wrap toggle - panel-specific
        function updateWordWrap(panel) {
            const panelMap = {
                html: { editor: htmlEditor, highlight: htmlHighlight, status: htmlWrapStatus },
                css: { editor: cssEditor, highlight: cssHighlight, status: cssWrapStatus },
                js: { editor: jsEditor, highlight: jsHighlight, status: jsWrapStatus }
            };

            const { editor, highlight, status } = panelMap[panel];

            if (wordWrapEnabled[panel]) {
                editor.classList.add('wrap-enabled');
                highlight.classList.add('wrap-enabled');
                status.textContent = 'On';
            } else {
                editor.classList.remove('wrap-enabled');
                highlight.classList.remove('wrap-enabled');
                status.textContent = 'Off';
            }

            localStorage.setItem(`coded-wordwrap-${panel}`, wordWrapEnabled[panel]);
        }

        htmlWrapToggle.addEventListener('click', () => {
            wordWrapEnabled.html = !wordWrapEnabled.html;
            updateWordWrap('html');
        });

        cssWrapToggle.addEventListener('click', () => {
            wordWrapEnabled.css = !wordWrapEnabled.css;
            updateWordWrap('css');
        });

        jsWrapToggle.addEventListener('click', () => {
            wordWrapEnabled.js = !wordWrapEnabled.js;
            updateWordWrap('js');
        });

        // CSS Reset/Normalize toggle
        const CSS_NORMALIZE = `/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}`;

        const CSS_RESET = `/* CSS Reset */html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}`;

        function getCssResetCode() {
            if (cssResetType === 'normalize') return CSS_NORMALIZE;
            if (cssResetType === 'reset') return CSS_RESET;
            return '';
        }

        cssResetBtn.addEventListener('click', () => {
            // Cycle through: none -> normalize -> reset -> none
            if (cssResetType === 'none') {
                cssResetType = 'normalize';
            } else if (cssResetType === 'normalize') {
                cssResetType = 'reset';
            } else {
                cssResetType = 'none';
            }

            cssResetStatus.textContent = cssResetType === 'none' ? 'None' :
                                         cssResetType === 'normalize' ? 'Normalize' : 'Reset';
            localStorage.setItem('coded-css-reset', cssResetType);

            // Re-run code to apply the reset
            if (htmlEditor.value || cssEditor.value || jsEditor.value) {
                runCode();
            }
        });

        saveSnippetMenuBtn.addEventListener('click', () => {
            saveCurrentSnippet();
        });

        snippetsMenuBtn.addEventListener('click', openSnippetsModal);
        closeSnippetsBtn.addEventListener('click', closeSnippetsModal);
        snippetsOverlay.addEventListener('click', closeSnippetsModal);

        // Load saved code from localStorage
        function loadCode() {
            const savedHTML = localStorage.getItem('coded-html') || '';
            const savedCSS = localStorage.getItem('coded-css') || '';
            const savedJS = localStorage.getItem('coded-js') || '';

            htmlEditor.value = savedHTML;
            cssEditor.value = savedCSS;
            jsEditor.value = savedJS;

            // Update highlights and line numbers
            highlightEditor(htmlEditor, htmlHighlight, 'markup');
            highlightEditor(cssEditor, cssHighlight, 'css');
            highlightEditor(jsEditor, jsHighlight, 'javascript');

            updateLineNumbers(htmlEditor, htmlLineNumbers);
            updateLineNumbers(cssEditor, cssLineNumbers);
            updateLineNumbers(jsEditor, jsLineNumbers);

            // Run on load if there's saved code
            if (savedHTML || savedCSS || savedJS) {
                runCode();
            }
        }

        // Save code to localStorage
        function saveCode() {
            localStorage.setItem('coded-html', htmlEditor.value);
            localStorage.setItem('coded-css', cssEditor.value);
            localStorage.setItem('coded-js', jsEditor.value);
        }

        // Add event listeners for live highlighting and auto-save
        htmlEditor.addEventListener('input', () => {
            highlightEditor(htmlEditor, htmlHighlight, 'markup');
            updateLineNumbers(htmlEditor, htmlLineNumbers);
            saveCode();
            debouncedAutoRun();
        });
        htmlEditor.addEventListener('scroll', () => {
            syncScroll(htmlEditor, htmlHighlight);
            syncLineNumbersScroll(htmlEditor, htmlLineNumbers);
        });

        // Sync on click/mousedown to ensure cursor positioning is accurate
        htmlEditor.addEventListener('mousedown', () => {
            syncScroll(htmlEditor, htmlHighlight);
        });
        htmlEditor.addEventListener('click', () => {
            syncScroll(htmlEditor, htmlHighlight);
            syncScrollRaf(htmlEditor, htmlHighlight);
        });
        htmlEditor.addEventListener('focus', () => {
            syncScrollRaf(htmlEditor, htmlHighlight);
        });
        htmlEditor.addEventListener('keyup', () => {
            syncScrollRaf(htmlEditor, htmlHighlight);
        });
        htmlEditor.addEventListener('select', () => {
            syncScrollRaf(htmlEditor, htmlHighlight);
        });
        htmlEditor.addEventListener('selectionchange', () => {
            syncScrollRaf(htmlEditor, htmlHighlight);
        });

        cssEditor.addEventListener('input', () => {
            highlightEditor(cssEditor, cssHighlight, 'css');
            updateLineNumbers(cssEditor, cssLineNumbers);
            saveCode();
            debouncedAutoRun();
        });
        cssEditor.addEventListener('scroll', () => {
            syncScroll(cssEditor, cssHighlight);
            syncLineNumbersScroll(cssEditor, cssLineNumbers);
        });

        // Sync on click/mousedown to ensure cursor positioning is accurate
        cssEditor.addEventListener('mousedown', () => {
            syncScroll(cssEditor, cssHighlight);
        });
        cssEditor.addEventListener('click', () => {
            syncScroll(cssEditor, cssHighlight);
            syncScrollRaf(cssEditor, cssHighlight);
        });
        cssEditor.addEventListener('focus', () => {
            syncScrollRaf(cssEditor, cssHighlight);
        });
        cssEditor.addEventListener('keyup', () => {
            syncScrollRaf(cssEditor, cssHighlight);
        });
        cssEditor.addEventListener('select', () => {
            syncScrollRaf(cssEditor, cssHighlight);
        });
        cssEditor.addEventListener('selectionchange', () => {
            syncScrollRaf(cssEditor, cssHighlight);
        });

        jsEditor.addEventListener('input', () => {
            highlightEditor(jsEditor, jsHighlight, 'javascript');
            updateLineNumbers(jsEditor, jsLineNumbers);
            saveCode();
            debouncedAutoRun();
        });
        jsEditor.addEventListener('scroll', () => {
            syncScroll(jsEditor, jsHighlight);
            syncLineNumbersScroll(jsEditor, jsLineNumbers);
        });

        // Sync on click/mousedown to ensure cursor positioning is accurate
        jsEditor.addEventListener('mousedown', () => {
            syncScroll(jsEditor, jsHighlight);
        });
        jsEditor.addEventListener('click', () => {
            syncScroll(jsEditor, jsHighlight);
            syncScrollRaf(jsEditor, jsHighlight);
        });
        jsEditor.addEventListener('focus', () => {
            syncScrollRaf(jsEditor, jsHighlight);
        });
        jsEditor.addEventListener('keyup', () => {
            syncScrollRaf(jsEditor, jsHighlight);
        });
        jsEditor.addEventListener('select', () => {
            syncScrollRaf(jsEditor, jsHighlight);
        });
        jsEditor.addEventListener('selectionchange', () => {
            syncScrollRaf(jsEditor, jsHighlight);
        });

        // Wait for fonts to load, then sync everything
        if (document.fonts && document.fonts.ready) {
            document.fonts.ready.then(() => {
                setTimeout(() => {
                    syncScroll(htmlEditor, htmlHighlight);
                    syncScroll(cssEditor, cssHighlight);
                    syncScroll(jsEditor, jsHighlight);
                }, 100);
            });
        }

        // Tab trapping state
        let tabTrappingEnabled = {
            html: false,
            css: false,
            js: false
        };

        // HTML tag auto-completion
        function handleTagCompletion(e, editor) {
            if (e.key === '>' && editor === htmlEditor) {
                const cursorPos = editor.selectionStart;
                const textBefore = editor.value.substring(0, cursorPos);
                const tagMatch = textBefore.match(/<([a-zA-Z][a-zA-Z0-9]*)[^>]*$/);

                if (tagMatch && tagMatch[1]) {
                    const tagName = tagMatch[1];
                    const selfClosingTags = ['img', 'br', 'hr', 'input', 'meta', 'link', 'area', 'base', 'col', 'embed', 'source', 'track', 'wbr'];

                    if (!selfClosingTags.includes(tagName.toLowerCase())) {
                        const closingTag = `</${tagName}>`;
                        const textAfter = editor.value.substring(cursorPos);
                        editor.value = textBefore + '>' + closingTag + textAfter;
                        editor.selectionStart = editor.selectionEnd = cursorPos + 1;
                        e.preventDefault();
                        editor.dispatchEvent(new Event('input'));
                    }
                }
            }
        }

        // Enhanced tab and escape key handling
        function handleEditorKeys(e, editorName) {
            const editor = e.target;
            const editorContent = editor.closest('.editor-content');

            // HTML tag auto-completion
            handleTagCompletion(e, editor);

            // Enable tab trapping on first interaction
            if (!tabTrappingEnabled[editorName] && e.key !== 'Tab') {
                tabTrappingEnabled[editorName] = true;
                editorContent.classList.add('tab-trapped');
            }

            // Tab key - indent
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = editor.selectionStart;
                const end = editor.selectionEnd;

                if (e.shiftKey) {
                    // Shift+Tab - outdent
                    const lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
                    const beforeCursor = editor.value.substring(lineStart, start);
                    if (beforeCursor.startsWith('  ')) {
                        editor.value = editor.value.substring(0, lineStart) +
                                      editor.value.substring(lineStart + 2);
                        editor.selectionStart = editor.selectionEnd = start - 2;
                    }
                } else {
                    // Tab - indent
                    editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
                    editor.selectionStart = editor.selectionEnd = start + 2;
                }

                editor.dispatchEvent(new Event('input'));

                // Enable tab trapping
                if (!tabTrappingEnabled[editorName]) {
                    tabTrappingEnabled[editorName] = true;
                    editorContent.classList.add('tab-trapped');
                }
            }

            // Escape key - disable tab trapping and blur
            if (e.key === 'Escape') {
                tabTrappingEnabled[editorName] = false;
                editorContent.classList.remove('tab-trapped');
                editor.blur();

                // Announce to screen readers
                const announcement = document.createElement('div');
                announcement.setAttribute('role', 'status');
                announcement.setAttribute('aria-live', 'polite');
                announcement.className = 'sr-only';
                announcement.textContent = 'Editor exited. Tab key will now navigate between elements.';
                document.body.appendChild(announcement);
                setTimeout(() => announcement.remove(), 1000);
            }
        }

        // Focus handlers to show/hide tab trap indicator
        function handleEditorFocus(editorName) {
            return function(e) {
                const editorContent = e.target.closest('.editor-content');
                if (tabTrappingEnabled[editorName]) {
                    editorContent.classList.add('tab-trapped');
                }
            };
        }

        function handleEditorBlur(editorName) {
            return function(e) {
                const editorContent = e.target.closest('.editor-content');
                // Only remove if not tab trapped, or after a delay to prevent flicker
                setTimeout(() => {
                    if (document.activeElement !== e.target) {
                        editorContent.classList.remove('tab-trapped');
                    }
                }, 100);
            };
        }

        htmlEditor.addEventListener('keydown', (e) => handleEditorKeys(e, 'html'));
        htmlEditor.addEventListener('focus', handleEditorFocus('html'));
        htmlEditor.addEventListener('blur', handleEditorBlur('html'));

        cssEditor.addEventListener('keydown', (e) => handleEditorKeys(e, 'css'));
        cssEditor.addEventListener('focus', handleEditorFocus('css'));
        cssEditor.addEventListener('blur', handleEditorBlur('css'));

        jsEditor.addEventListener('keydown', (e) => handleEditorKeys(e, 'js'));
        jsEditor.addEventListener('focus', handleEditorFocus('js'));
        jsEditor.addEventListener('blur', handleEditorBlur('js'));

        // Console functionality
        let consoleVisible = localStorage.getItem('coded-console-visible') === 'true';

        function toggleConsole() {
            consoleVisible = !consoleVisible;
            if (consoleVisible) {
                consolePanel.classList.add('active');
                toggleConsoleBtn.style.background = 'var(--accent-color)';
                toggleConsoleBtn.style.color = 'var(--bg-color)';
            } else {
                consolePanel.classList.remove('active');
                toggleConsoleBtn.style.background = '';
                toggleConsoleBtn.style.color = '';
            }
            localStorage.setItem('coded-console-visible', consoleVisible);
        }

        function addConsoleMessage(type, args) {
            const message = document.createElement('div');
            message.className = `console-message ${type}`;

            const formatted = args.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');

            message.textContent = formatted;
            consoleOutput.appendChild(message);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        // Run code in preview
        function runCode() {
            const html = htmlEditor.value;
            const css = cssEditor.value;
            const js = jsEditor.value;
            const libraries = getAddedLibraries();
            const cssReset = getCssResetCode();

            // Build library tags
            const cssLibs = libraries.filter(l => l.type === 'css').map(l => `<link rel="stylesheet" href="${l.url}">`).join('\n    ');
            const jsLibs = libraries.filter(l => l.type === 'js').map(l => `<script src="${l.url}"><\/script>`).join('\n    ');

            const previewDoc = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    ${cssLibs}
    <style>
        ${cssReset}
        ${css}
    </style>
</head>
<body>
    ${html}
    ${jsLibs}
    <script>
        // Intercept console methods
        (function() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            const originalInfo = console.info;

            console.log = function(...args) {
                originalLog.apply(console, args);
                window.parent.postMessage({ type: 'console', method: 'log', args: args }, '*');
            };

            console.error = function(...args) {
                originalError.apply(console, args);
                window.parent.postMessage({ type: 'console', method: 'error', args: args }, '*');
            };

            console.warn = function(...args) {
                originalWarn.apply(console, args);
                window.parent.postMessage({ type: 'console', method: 'warn', args: args }, '*');
            };

            console.info = function(...args) {
                originalInfo.apply(console, args);
                window.parent.postMessage({ type: 'console', method: 'info', args: args }, '*');
            };

            // Catch errors
            window.onerror = function(msg, url, lineNo, columnNo, error) {
                console.error('Error:', msg, 'at line', lineNo);
                return false;
            };

            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled Promise Rejection:', event.reason);
            });
        })();

        try {
            ${js}
        } catch (error) {
            console.error('JavaScript Error:', error.message);
        }
    <\/script>
</body>
</html>
            `;

            // Write to iframe
            const previewFrame = preview.contentDocument || preview.contentWindow.document;
            previewFrame.open();
            previewFrame.write(previewDoc);
            previewFrame.close();
        }

        // Listen for console messages from iframe
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'console') {
                addConsoleMessage(event.data.method, event.data.args);
            }
        });

        // Console button event listeners
        toggleConsoleBtn.addEventListener('click', toggleConsole);
        clearConsoleBtn.addEventListener('click', clearConsole);

        // Initialize console visibility
        if (consoleVisible) {
            consolePanel.classList.add('active');
            toggleConsoleBtn.style.background = 'var(--accent-color)';
            toggleConsoleBtn.style.color = 'var(--bg-color)';
        }

        // Settings functionality
        let currentFontSize = parseInt(localStorage.getItem('coded-font-size')) || 14;
        let currentLayout = localStorage.getItem('coded-layout') || 'horizontal';

        function openSettingsModal() {
            settingsMenu.style.display = 'block';
            snippetsOverlay.style.display = 'block';
            moreOptionsMenu.classList.remove('active');
        }

        function closeSettingsModal() {
            settingsMenu.style.display = 'none';
            snippetsOverlay.style.display = 'none';
        }

        function updateFontSize(size) {
            currentFontSize = size;
            document.querySelectorAll('.editor, .editor-highlight code, .line-numbers').forEach(el => {
                el.style.fontSize = `${size}px`;
            });
            fontSizeValue.textContent = `${size}px`;
            fontSizeSlider.value = size;
            localStorage.setItem('coded-font-size', size);
        }

        function setLayout(layout) {
            currentLayout = layout;
            if (layout === 'vertical') {
                editorsSection.classList.add('vertical-layout');
                layoutVerticalBtn.classList.add('active');
                layoutVerticalBtn.style.background = 'var(--accent-color)';
                layoutVerticalBtn.style.color = 'var(--bg-color)';
                layoutVerticalBtn.style.borderColor = 'var(--accent-color)';
                layoutHorizontalBtn.classList.remove('active');
                layoutHorizontalBtn.style.background = 'none';
                layoutHorizontalBtn.style.color = 'var(--secondary-color)';
                layoutHorizontalBtn.style.borderColor = 'var(--editor-border)';
            } else {
                editorsSection.classList.remove('vertical-layout');
                layoutHorizontalBtn.classList.add('active');
                layoutHorizontalBtn.style.background = 'var(--accent-color)';
                layoutHorizontalBtn.style.color = 'var(--bg-color)';
                layoutHorizontalBtn.style.borderColor = 'var(--accent-color)';
                layoutVerticalBtn.classList.remove('active');
                layoutVerticalBtn.style.background = 'none';
                layoutVerticalBtn.style.color = 'var(--secondary-color)';
                layoutVerticalBtn.style.borderColor = 'var(--editor-border)';
            }
            localStorage.setItem('coded-layout', layout);
        }

        // Settings event listeners
        settingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);

        fontSizeSlider.addEventListener('input', (e) => {
            updateFontSize(parseInt(e.target.value));
        });

        layoutHorizontalBtn.addEventListener('click', () => {
            setLayout('horizontal');
        });

        layoutVerticalBtn.addEventListener('click', () => {
            setLayout('vertical');
        });

        // Initialize settings
        updateFontSize(currentFontSize);
        setLayout(currentLayout);

        // Find/Replace functionality
        let currentFindEditor = null;
        let lastSearchTerm = '';
        let lastSearchIndex = -1;

        function getActiveEditor() {
            // Return the last focused editor, defaulting to HTML editor
            if (document.activeElement === htmlEditor) return htmlEditor;
            if (document.activeElement === cssEditor) return cssEditor;
            if (document.activeElement === jsEditor) return jsEditor;
            return currentFindEditor || htmlEditor;
        }

        function openFindReplace() {
            findReplacePanel.style.display = 'block';
            currentFindEditor = getActiveEditor();
            findInput.focus();
            findInput.select();
        }

        function closeFindReplace() {
            findReplacePanel.style.display = 'none';
            if (currentFindEditor) {
                currentFindEditor.focus();
            }
        }

        function findNext() {
            const searchTerm = findInput.value;
            if (!searchTerm) {
                findResultsText.textContent = 'Enter search term';
                return;
            }

            const editor = getActiveEditor();
            const content = editor.value;
            const startPos = (lastSearchTerm === searchTerm && lastSearchIndex !== -1)
                ? lastSearchIndex + searchTerm.length
                : 0;

            const index = content.indexOf(searchTerm, startPos);

            if (index !== -1) {
                editor.focus();
                editor.setSelectionRange(index, index + searchTerm.length);
                editor.scrollTop = editor.scrollHeight * (index / content.length) - editor.clientHeight / 2;

                lastSearchTerm = searchTerm;
                lastSearchIndex = index;

                const occurrences = (content.match(new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length;
                const currentOccurrence = (content.substring(0, index).match(new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length + 1;
                findResultsText.textContent = `${currentOccurrence} of ${occurrences}`;
            } else if (startPos > 0) {
                // Wrap around
                lastSearchIndex = -1;
                findNext();
            } else {
                findResultsText.textContent = 'Not found';
                lastSearchIndex = -1;
            }
        }

        function findPrev() {
            const searchTerm = findInput.value;
            if (!searchTerm) {
                findResultsText.textContent = 'Enter search term';
                return;
            }

            const editor = getActiveEditor();
            const content = editor.value;
            const startPos = lastSearchIndex !== -1 ? lastSearchIndex - 1 : content.length;

            const index = content.lastIndexOf(searchTerm, startPos);

            if (index !== -1) {
                editor.focus();
                editor.setSelectionRange(index, index + searchTerm.length);
                editor.scrollTop = editor.scrollHeight * (index / content.length) - editor.clientHeight / 2;

                lastSearchTerm = searchTerm;
                lastSearchIndex = index;

                const occurrences = (content.match(new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length;
                const currentOccurrence = (content.substring(0, index).match(new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length + 1;
                findResultsText.textContent = `${currentOccurrence} of ${occurrences}`;
            } else if (startPos < content.length) {
                // Wrap around
                lastSearchIndex = content.length + 1;
                findPrev();
            } else {
                findResultsText.textContent = 'Not found';
                lastSearchIndex = -1;
            }
        }

        function replaceOne() {
            const searchTerm = findInput.value;
            const replacement = replaceInput.value;
            if (!searchTerm) return;

            const editor = getActiveEditor();
            const selStart = editor.selectionStart;
            const selEnd = editor.selectionEnd;
            const selectedText = editor.value.substring(selStart, selEnd);

            if (selectedText === searchTerm) {
                editor.value = editor.value.substring(0, selStart) + replacement + editor.value.substring(selEnd);
                editor.setSelectionRange(selStart, selStart + replacement.length);

                // Trigger updates
                editor.dispatchEvent(new Event('input'));

                // Find next occurrence
                setTimeout(() => findNext(), 50);
            } else {
                findNext();
            }
        }

        function replaceAll() {
            const searchTerm = findInput.value;
            const replacement = replaceInput.value;
            if (!searchTerm) return;

            const editor = getActiveEditor();
            const escapedSearch = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(escapedSearch, 'g');
            const count = (editor.value.match(regex) || []).length;

            if (count > 0) {
                editor.value = editor.value.replace(regex, replacement);

                // Trigger updates
                editor.dispatchEvent(new Event('input'));

                findResultsText.textContent = `Replaced ${count} occurrence${count > 1 ? 's' : ''}`;
                lastSearchIndex = -1;
            } else {
                findResultsText.textContent = 'Not found';
            }
        }

        // Find/Replace event listeners
        closeFindReplaceBtn.addEventListener('click', closeFindReplace);
        findNextBtn.addEventListener('click', findNext);
        findPrevBtn.addEventListener('click', findPrev);
        replaceBtn.addEventListener('click', replaceOne);
        replaceAllBtn.addEventListener('click', replaceAll);

        findInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (e.shiftKey) {
                    findPrev();
                } else {
                    findNext();
                }
            } else if (e.key === 'Escape') {
                closeFindReplace();
            }
        });

        replaceInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                replaceOne();
            } else if (e.key === 'Escape') {
                closeFindReplace();
            }
        });

        // Reset search when input changes
        findInput.addEventListener('input', () => {
            lastSearchIndex = -1;
            lastSearchTerm = '';
        });

        // Clear all code
        function clearAll() {
            if (confirm('Are you sure you want to clear all code?')) {
                htmlEditor.value = '';
                cssEditor.value = '';
                jsEditor.value = '';
                htmlHighlight.innerHTML = '';
                cssHighlight.innerHTML = '';
                jsHighlight.innerHTML = '';
                localStorage.removeItem('coded-html');
                localStorage.removeItem('coded-css');
                localStorage.removeItem('coded-js');

                // Clear preview
                const previewFrame = preview.contentDocument || preview.contentWindow.document;
                previewFrame.open();
                previewFrame.write('<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body></body></html>');
                previewFrame.close();
            }
        }

        // Export code as HTML file
        function exportCode() {
            const html = htmlEditor.value;
            const css = cssEditor.value;
            const js = jsEditor.value;

            const exportDoc = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coded Export</title>
    <style>
${css}
    </style>
</head>
<body>
${html}
    <script>
${js}
    <\/script>
</body>
</html>`;

            // Create blob and download
            const blob = new Blob([exportDoc], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'coded-export.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Share code as .coded file
        function shareCode() {
            const html = htmlEditor.value;
            const css = cssEditor.value;
            const js = jsEditor.value;

            // Check if there's any code to share
            if (!html && !css && !js) {
                alert('Add some code first before sharing!');
                return;
            }

            // Prompt for a filename
            const name = prompt('Give your share a name (e.g., "Accessible Panel Demo"):');
            if (!name || !name.trim()) {
                return;
            }

            try {
                // Create share data
                const shareData = {
                    name: name.trim(),
                    html: html,
                    css: css,
                    js: js,
                    created: new Date().toISOString(),
                    version: '1.0'
                };

                // Convert to JSON and create a Blob
                const jsonString = JSON.stringify(shareData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });

                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // Sanitize filename
                const filename = name.trim().replace(/[^a-z0-9]/gi, '-').toLowerCase();
                a.download = `${filename}.coded`;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert(`Share file "${filename}.coded" downloaded!\n\nYou can share this file with anyone. They can drag & drop it into Coded to load your code.`);
                moreOptionsMenu.classList.remove('active');
            } catch (e) {
                console.error('Share error:', e);
                alert('Failed to create share file. Please try again.');
            }
        }

        // Load code from URL parameter
        function loadFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');

            if (!shareId) {
                return; // No share parameter, skip
            }

            // Fetch from backend
            fetch(`/api/share?id=${encodeURIComponent(shareId)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Share not found');
                    }
                    return response.json();
                })
                .then(data => {
                    // Load the code
                    htmlEditor.value = data.html || '';
                    cssEditor.value = data.css || '';
                    jsEditor.value = data.js || '';

                    // Update highlights
                    highlightEditor(htmlEditor, htmlHighlight, 'markup');
                    highlightEditor(cssEditor, cssHighlight, 'css');
                    highlightEditor(jsEditor, jsHighlight, 'javascript');

                    // Run the code
                    runCode();

                    // Enter share mode
                    isShareMode = true;
                    shareModeBanner.classList.add('active');
                    document.body.classList.add('share-mode');

                    // Clean URL (remove share parameter) but keep share mode active
                    window.history.replaceState({}, document.title, window.location.pathname);
                })
                .catch(e => {
                    console.error('Failed to load shared code:', e);
                    alert('Failed to load shared code. The share may not exist or the server may be unavailable.');
                });
        }

        // Update share link (creates new share URL with current code)
        function updateShareLink() {
            shareCode(); // Reuse the share function
        }

        // Exit share mode and start fresh
        function startFresh() {
            if (confirm('Start fresh? This will clear all code and exit share mode.')) {
                // Clear all code
                htmlEditor.value = '';
                cssEditor.value = '';
                jsEditor.value = '';
                htmlHighlight.innerHTML = '';
                cssHighlight.innerHTML = '';
                jsHighlight.innerHTML = '';

                // Clear preview
                const previewFrame = preview.contentDocument || preview.contentWindow.document;
                previewFrame.open();
                previewFrame.write('<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body></body></html>');
                previewFrame.close();

                // Exit share mode
                isShareMode = false;
                shareModeBanner.classList.remove('active');
                document.body.classList.remove('share-mode');

                // Don't save to localStorage - truly fresh start
            }
        }

        // Auto-run toggle
        autoRunToggle.checked = autoRunEnabled;
        autoRunToggle.addEventListener('change', (e) => {
            autoRunEnabled = e.target.checked;
            localStorage.setItem('coded-autorun', autoRunEnabled);
        });

        // Panel resizing
        let isResizing = false;
        let startY = 0;
        let startEditorHeight = 0;
        let currentEditorPercent = null;

        function startResize(clientY) {
            isResizing = true;
            startY = clientY;
            startEditorHeight = editorsSection.offsetHeight;
            resizer.classList.add('resizing');
            document.body.classList.add('resizing');
            document.body.style.cursor = 'row-resize';

            // Force a layout calculation before starting to ensure smooth resize
            editorsSection.offsetHeight;
            previewSection.offsetHeight;
        }

        function handleResize(clientY) {
            if (!isResizing) return;

            const deltaY = clientY - startY;
            const containerHeight = container.offsetHeight;
            const newEditorHeight = startEditorHeight + deltaY;
            const minHeight = 150;
            const maxHeight = containerHeight - 150;

            if (newEditorHeight >= minHeight && newEditorHeight <= maxHeight) {
                const editorPercent = (newEditorHeight / containerHeight) * 100;
                currentEditorPercent = editorPercent;
                editorsSection.style.height = `${editorPercent}%`;
                previewSection.style.flex = 'unset';
                previewSection.style.height = `calc(${100 - editorPercent}% - 4px)`;
            }
        }

        function endResize() {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('resizing');
                document.body.classList.remove('resizing');
                document.body.style.cursor = '';

                // Save the resize state
                if (currentEditorPercent !== null) {
                    localStorage.setItem('coded-panel-height', currentEditorPercent);
                }

                // Sync all editors after resize to ensure cursor positioning is accurate
                syncScroll(htmlEditor, htmlHighlight);
                syncScroll(cssEditor, cssHighlight);
                syncScroll(jsEditor, jsHighlight);
            }
        }

        function resetPanelSizes() {
            // Clear inline styles to let CSS take over
            editorsSection.style.height = '';
            previewSection.style.flex = '';
            previewSection.style.height = '';
            currentEditorPercent = null;
            localStorage.removeItem('coded-panel-height');

            // Sync all editors after reset to ensure cursor positioning is accurate
            setTimeout(() => {
                syncScroll(htmlEditor, htmlHighlight);
                syncScroll(cssEditor, cssHighlight);
                syncScroll(jsEditor, jsHighlight);
            }, 10);
        }

        function applyStoredPanelSize() {
            const stored = localStorage.getItem('coded-panel-height');
            if (stored) {
                const percent = parseFloat(stored);
                editorsSection.style.height = `${percent}%`;
                previewSection.style.flex = 'unset';
                previewSection.style.height = `calc(${100 - percent}% - 4px)`;
                currentEditorPercent = percent;
            }
        }

        // Mouse events
        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startResize(e.clientY);
        });

        // Double-click to reset to default size
        resizer.addEventListener('dblclick', () => {
            resetPanelSizes();
        });

        document.addEventListener('mousemove', (e) => {
            if (isResizing) {
                e.preventDefault();
                handleResize(e.clientY);
            }
        });

        document.addEventListener('mouseup', (e) => {
            e.preventDefault();
            endResize();
        });

        // Stop resizing if mouse leaves the window
        document.addEventListener('mouseleave', () => {
            endResize();
        });

        // Also stop if focus is lost
        window.addEventListener('blur', () => {
            endResize();
        });

        // Touch events for mobile/tablet
        resizer.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startResize(e.touches[0].clientY);
        });

        document.addEventListener('touchmove', (e) => {
            if (isResizing) {
                e.preventDefault();
                handleResize(e.touches[0].clientY);
            }
        }, { passive: false });

        document.addEventListener('touchend', () => {
            endResize();
        });

        document.addEventListener('touchcancel', () => {
            endResize();
        });

        // Reset panel sizes on window resize to prevent breakpoint issues
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                // Only reset if viewport width changed significantly (breakpoint change)
                const viewportWidth = window.innerWidth;
                const lastWidth = parseInt(localStorage.getItem('coded-viewport-width') || '0');

                if (Math.abs(viewportWidth - lastWidth) > 100) {
                    resetPanelSizes();
                    localStorage.setItem('coded-viewport-width', viewportWidth);
                } else if (currentEditorPercent !== null) {
                    // Recalculate percentages if minor resize
                    const containerHeight = container.offsetHeight;
                    const currentHeight = editorsSection.offsetHeight;
                    const newPercent = (currentHeight / containerHeight) * 100;
                    editorsSection.style.height = `${newPercent}%`;
                    previewSection.style.height = `calc(${100 - newPercent}% - 4px)`;
                }

                // Sync all editors after window resize to ensure cursor positioning is accurate
                syncScroll(htmlEditor, htmlHighlight);
                syncScroll(cssEditor, cssHighlight);
                syncScroll(jsEditor, jsHighlight);
            }, 250);
        });

        // Event listeners
        runBtn.addEventListener('click', runCode);
        clearBtn.addEventListener('click', clearAll);
        exportBtn.addEventListener('click', exportCode);
        shareBtn.addEventListener('click', shareCode);
        updateShareBtn.addEventListener('click', updateShareLink);
        startFreshBtn.addEventListener('click', startFresh);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd/Ctrl + F to open find/replace
            if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
                e.preventDefault();
                openFindReplace();
            }
            // Cmd/Ctrl + Enter to run
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
            // Cmd/Ctrl + S to save (already auto-saving, but prevent browser save dialog)
            if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                e.preventDefault();
                saveCode();
            }
            // Cmd/Ctrl + E to export
            if ((e.metaKey || e.ctrlKey) && e.key === 'e') {
                e.preventDefault();
                exportCode();
            }
        });

        // Auto-run toggle initialization
        autoRunToggle.checked = autoRunEnabled;

        // Initialize word wrap for each panel
        updateWordWrap('html');
        updateWordWrap('css');
        updateWordWrap('js');

        // Initialize CSS reset status
        cssResetStatus.textContent = cssResetType === 'none' ? 'None' :
                                     cssResetType === 'normalize' ? 'Normalize' : 'Reset';

        // Apply stored panel size
        applyStoredPanelSize();

        // Check for shared code in URL first, then load from localStorage
        loadFromUrl();

        // Only load from localStorage if there was no share parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('share')) {
            loadCode();
        }

        // Load .coded file function
        function loadCodedFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const shareData = JSON.parse(e.target.result);

                    // Validate the file structure
                    if (!shareData.version || (!shareData.html && !shareData.css && !shareData.js)) {
                        alert('Invalid .coded file format.');
                        return;
                    }

                    // Load the code
                    htmlEditor.value = shareData.html || '';
                    cssEditor.value = shareData.css || '';
                    jsEditor.value = shareData.js || '';

                    // Update highlights
                    highlightEditor(htmlEditor, htmlHighlight, 'markup');
                    highlightEditor(cssEditor, cssHighlight, 'css');
                    highlightEditor(jsEditor, jsHighlight, 'javascript');

                    // Run the code
                    runCode();

                    alert(`Loaded: ${shareData.name || 'Untitled'}`);
                } catch (err) {
                    console.error('Error loading .coded file:', err);
                    alert('Failed to load .coded file. The file may be corrupted.');
                }
            };
            reader.readAsText(file);
        }

        // Add "Load .coded File" menu option
        const loadCodedFileBtn = document.createElement('div');
        loadCodedFileBtn.className = 'more-option-item';
        loadCodedFileBtn.id = 'loadCodedFileBtn';
        loadCodedFileBtn.innerHTML = 'üìÇ Load .coded File';
        loadCodedFileBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.coded';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    loadCodedFile(file);
                }
            };
            input.click();
            moreOptionsMenu.classList.remove('active');
        });

        // Insert after "Share Link" button in menu
        if (shareBtn && shareBtn.parentNode) {
            shareBtn.parentNode.insertBefore(loadCodedFileBtn, shareBtn.nextSibling);
        }
    </script>
</body>
</html>
