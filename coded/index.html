<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Coded - A lightweight code playground for quick prototyping">
    <title>Coded - Code Playground</title>

    <!-- Password protection with accessible modal -->
    <script>
        (function() {
            // SHA-256 hash of your password (not the actual password)
            // To generate a new hash: node -e "console.log(require('crypto').createHash('sha256').update('YOUR_PASSWORD').digest('hex'))"
            const PASSWORD_HASH = 'b072a58dc6d41ac57067e5cf04f38ca5e575d56af2af78680fd7d2e071626d4e';

            const hasAccess = sessionStorage.getItem('codedAccess') === PASSWORD_HASH;

            if (!hasAccess) {
                // Prevent page load while checking
                document.documentElement.style.display = 'none';

                // Show password modal after DOM loads
                document.addEventListener('DOMContentLoaded', function() {
                    const modal = document.getElementById('passwordModal');
                    const input = document.getElementById('passwordInput');
                    const submitBtn = document.getElementById('passwordSubmit');
                    const cancelBtn = document.getElementById('passwordCancel');
                    const errorDiv = document.getElementById('passwordError');
                    const form = document.getElementById('passwordForm');

                    // Show modal and focus input
                    modal.style.display = 'flex';
                    setTimeout(() => input.focus(), 100);

                    // Focus trap elements
                    const focusableElements = modal.querySelectorAll(
                        'input, button, [tabindex]:not([tabindex="-1"])'
                    );
                    const firstElement = focusableElements[0];
                    const lastElement = focusableElements[focusableElements.length - 1];

                    // Trap focus within modal
                    modal.addEventListener('keydown', function(e) {
                        if (e.key === 'Tab') {
                            if (e.shiftKey && document.activeElement === firstElement) {
                                e.preventDefault();
                                lastElement.focus();
                            } else if (!e.shiftKey && document.activeElement === lastElement) {
                                e.preventDefault();
                                firstElement.focus();
                            }
                        }
                    });

                    async function verifyPassword() {
                        const userPassword = input.value;
                        if (!userPassword) {
                            errorDiv.textContent = 'Please enter a password.';
                            return;
                        }

                        // Hash the user's input
                        try {
                            const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(userPassword));
                            const hashArray = Array.from(new Uint8Array(hashBuffer));
                            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                            if (hashHex === PASSWORD_HASH) {
                                sessionStorage.setItem('codedAccess', PASSWORD_HASH);
                                errorDiv.textContent = '';
                                modal.style.display = 'none';
                                document.documentElement.style.display = '';
                            } else {
                                errorDiv.textContent = 'Incorrect password. Please try again.';
                                input.value = '';
                                input.focus();
                            }
                        } catch (error) {
                            errorDiv.textContent = 'An error occurred. Please try again.';
                        }
                    }

                    // Submit on button click
                    submitBtn.addEventListener('click', verifyPassword);

                    // Submit on Enter key
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        verifyPassword();
                    });

                    // Cancel redirects to home
                    cancelBtn.addEventListener('click', function() {
                        window.location.href = '/';
                    });

                    // Escape key also cancels
                    modal.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            window.location.href = '/';
                        }
                    });
                });
            } else {
                // User has access, show page immediately
                document.documentElement.style.display = '';
            }
        })();
    </script>

    <!-- Prism.js for syntax highlighting -->
    <link href="/coded/vendor/prism-okaidia.min.css" rel="stylesheet">

    <link rel="stylesheet" href="/coded/styles.css">
</head>
<body>
    <!-- Password Modal -->
    <div id="passwordModal" class="password-modal" role="dialog" aria-modal="true" aria-labelledby="passwordTitle" style="display: none;">
        <div class="password-modal-content">
            <h2 id="passwordTitle">Password Required</h2>
            <p>This page is password protected. Please enter the password to continue.</p>
            <form id="passwordForm" onsubmit="return false;">
                <label for="passwordInput" class="sr-only">Password</label>
                <input
                    type="password"
                    id="passwordInput"
                    aria-label="Enter password"
                    placeholder="Enter password"
                    aria-describedby="passwordError"
                    autocomplete="off"
                />
                <div id="passwordError" class="password-error" role="alert" aria-live="polite"></div>
                <div class="password-modal-actions">
                    <button type="submit" id="passwordSubmit" class="password-submit-btn">Submit</button>
                    <button type="button" id="passwordCancel" class="password-cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Skip link for keyboard accessibility -->
    <a href="#htmlEditor" class="skip-link">Skip to code editor</a>

    <!-- Share Mode Banner -->
    <div class="share-mode-banner" id="shareModeBanner" role="status" aria-live="polite">
        <div class="share-mode-info">
            <span style="font-size: 1.2rem;">üîó</span>
            <span><strong>Viewing shared code</strong> ‚Äî Make your own edits and share them!</span>
        </div>
        <div class="share-mode-actions">
            <button class="share-mode-button primary" id="updateShareBtn">Update Share Link</button>
            <button class="share-mode-button secondary" id="startFreshBtn">Start fresh</button>
        </div>
    </div>

    <header>
        <h1>&lt;/Coded&gt;</h1>
        <div class="header-actions">
            <div class="auto-run-toggle">
                <input type="checkbox" id="autoRunToggle" />
                <label for="autoRunToggle">Auto-run</label>
            </div>
            <button class="run-button" id="runBtn">Run Code</button>
            <div class="more-options-dropdown">
                <button class="more-options-button" id="moreOptionsBtn" aria-label="More options">
                    ‚ãØ
                </button>
                <div class="more-options-menu" id="moreOptionsMenu">
                    <div class="more-option-item" id="settingsBtn">
                        Settings
                    </div>
                    <div class="more-option-item" id="saveSnippetMenuBtn">
                        Save snippet
                    </div>
                    <div class="more-option-item" id="snippetsMenuBtn">
                        Load snippet
                    </div>
                    <div class="more-option-item" id="shareBtn">
                        Save .coded file
                    </div>
                    <div class="more-option-item" id="exportBtn">
                        Export HTML
                    </div>
                    <div class="more-option-item" id="clearBtn">
                        Clear all
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Snippets Modal -->
    <div class="snippets-menu" id="snippetsMenu" role="dialog" aria-modal="true" aria-labelledby="snippetsMenuTitle" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none;">
        <div class="snippets-menu-header">
            <span id="snippetsMenuTitle">Load snippet</span>
            <span style="cursor: pointer; opacity: 0.7;" id="closeSnippetsBtn" role="button" tabindex="0" aria-label="Close snippets menu">‚úï</span>
        </div>
        <div class="modal-helper-text">Load previously saved code snippets to quickly start new projects.</div>
        <div class="modal-content">
            <div id="snippetsList"></div>
        </div>
    </div>

    <!-- Libraries Modal -->
    <div class="snippets-menu" id="librariesMenu" role="dialog" aria-modal="true" aria-labelledby="librariesMenuTitle" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none;">
        <div class="snippets-menu-header">
            <span id="librariesMenuTitle">Add external libraries</span>
            <span style="cursor: pointer; opacity: 0.7;" id="closeLibrariesBtn" role="button" tabindex="0" aria-label="Close libraries menu">‚úï</span>
        </div>
        <div class="modal-helper-text">Include popular libraries or add your own via CDN URL.</div>
        <div class="modal-content">
            <div style="padding: 1rem; border-bottom: 1px solid var(--editor-border);">
                <div style="margin-bottom: 1rem;">
                    <strong style="display: block; margin-bottom: 0.5rem; color: var(--accent-color);">Popular libraries</strong>
                    <div id="popularLibraries"></div>
                </div>
                <div>
                    <strong style="display: block; margin-bottom: 0.5rem; color: var(--accent-color);">Custom CDN</strong>
                    <input type="text" id="customCdnInput" placeholder="Paste CDN URL..." style="width: 100%; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--editor-border); border-radius: 4px; color: var(--text-color); font-family: var(--font-main); font-size: 0.9rem; margin-bottom: 0.5rem;">
                    <button id="addCustomCdnBtn" style="width: 100%; padding: 0.5rem; background: var(--accent-color); color: var(--bg-color); border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Add custom CDN</button>
                </div>
            </div>
            <div style="padding: 1rem;">
                <strong style="display: block; margin-bottom: 0.5rem; color: var(--accent-color);">Added libraries</strong>
                <div id="addedLibrariesList"></div>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div class="snippets-menu" id="templatesMenu" role="dialog" aria-modal="true" aria-labelledby="templatesMenuTitle" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none;">
        <div class="snippets-menu-header">
            <span id="templatesMenuTitle">Select template</span>
            <span style="cursor: pointer; opacity: 0.7;" id="closeTemplatesBtn" role="button" tabindex="0" aria-label="Close templates menu">‚úï</span>
        </div>
        <div class="modal-helper-text">Select a template to load into the editor. This will replace current content.</div>
        <div class="modal-content">
            <div style="padding: 1.5rem;">
                <div id="templatesList"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="snippets-menu" id="settingsMenu" role="dialog" aria-modal="true" aria-labelledby="settingsMenuTitle" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; display: none; max-width: 500px;">
        <div class="snippets-menu-header">
            <span id="settingsMenuTitle">Settings</span>
            <span style="cursor: pointer; opacity: 0.7;" id="closeSettingsBtn" role="button" tabindex="0" aria-label="Close settings">‚úï</span>
        </div>
        <div class="modal-helper-text">Customize your editor experience with layout, theme, and syntax highlighting options.</div>
        <div class="modal-content">
            <div style="padding: 1.5rem;">
                <!-- Layout Toggle -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 500;">Editor layout</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="layout-toggle-btn active" id="layoutHorizontalBtn" style="flex: 1; padding: 0.75rem; background: var(--accent-color); color: var(--bg-color); border: 2px solid var(--accent-color); border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            Horizontal
                        </button>
                        <button class="layout-toggle-btn" id="layoutVerticalBtn" style="flex: 1; padding: 0.75rem; background: none; color: var(--secondary-color); border: 2px solid var(--editor-border); border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            Vertical
                        </button>
                    </div>
                </div>

                <!-- Theme -->
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 500;">Theme</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="theme-toggle-btn active" id="themeDarkBtn" style="flex: 1; padding: 0.75rem; background: var(--accent-color); color: var(--bg-color); border: 2px solid var(--accent-color); border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            Dark
                        </button>
                        <button class="theme-toggle-btn" id="themeLightBtn" style="flex: 1; padding: 0.75rem; background: none; color: var(--secondary-color); border: 2px solid var(--editor-border); border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            Light
                        </button>
                    </div>
                </div>

                <!-- Syntax Highlighting -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-color); font-weight: 500;">Syntax highlighting</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="syntax-toggle-btn active" id="syntaxOnBtn" style="flex: 1; padding: 0.75rem; background: var(--accent-color); color: var(--bg-color); border: 2px solid var(--accent-color); border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            On
                        </button>
                        <button class="syntax-toggle-btn" id="syntaxOffBtn" style="flex: 1; padding: 0.75rem; background: none; color: var(--secondary-color); border: 2px solid var(--editor-border); border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                            Off
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="snippetsOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1999;"></div>

    <!-- Find/Replace Panel -->
    <div id="findReplacePanel" role="dialog" aria-labelledby="findReplaceTitle" style="display: none; position: fixed; top: 80px; right: 20px; background: var(--editor-bg); border: 2px solid var(--editor-border); border-radius: 8px; padding: 1rem; z-index: 3000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); min-width: 350px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <span id="findReplaceTitle" style="font-weight: 500; color: var(--accent-color);">Find & replace</span>
            <span id="closeFindReplaceBtn" role="button" tabindex="0" aria-label="Close find and replace" style="cursor: pointer; opacity: 0.7; font-size: 1.2rem; color: var(--secondary-color);">‚úï</span>
        </div>

        <div style="margin-bottom: 0.5rem;">
            <label for="findInput" class="sr-only">Find text</label>
            <input type="text" id="findInput" placeholder="Find..." aria-label="Find text" style="width: 100%; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--editor-border); border-radius: 4px; color: var(--text-color); font-family: var(--font-main); font-size: 0.9rem;">
        </div>

        <div style="margin-bottom: 0.75rem;">
            <label for="replaceInput" class="sr-only">Replace with</label>
            <input type="text" id="replaceInput" placeholder="Replace with..." aria-label="Replace with" style="width: 100%; padding: 0.5rem; background: var(--bg-color); border: 1px solid var(--editor-border); border-radius: 4px; color: var(--text-color); font-family: var(--font-main); font-size: 0.9rem;">
        </div>

        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button id="findPrevBtn" style="flex: 1; min-width: 70px; padding: 0.5rem; background: none; border: 1px solid var(--editor-border); color: var(--secondary-color); border-radius: 4px; cursor: pointer; font-size: 0.85rem;">‚Üê Prev</button>
            <button id="findNextBtn" style="flex: 1; min-width: 70px; padding: 0.5rem; background: var(--accent-color); border: 1px solid var(--accent-color); color: var(--bg-color); border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.85rem;">Next ‚Üí</button>
            <button id="replaceBtn" style="flex: 1; min-width: 70px; padding: 0.5rem; background: none; border: 1px solid var(--editor-border); color: var(--secondary-color); border-radius: 4px; cursor: pointer; font-size: 0.85rem;">Replace</button>
            <button id="replaceAllBtn" style="flex: 1; min-width: 70px; padding: 0.5rem; background: none; border: 1px solid var(--editor-border); color: var(--secondary-color); border-radius: 4px; cursor: pointer; font-size: 0.85rem;">All</button>
        </div>

        <div style="margin-top: 0.75rem; font-size: 0.8rem; color: var(--secondary-color); opacity: 0.7;">
            <span id="findResultsText">Press Enter or click Next</span>
        </div>
    </div>

    <div class="container">
        <!-- Editors Section -->
        <div class="editors">
            <div class="editor-panel">
                <div class="editor-header">
                    <span>HTML</span>
                    <button class="panel-settings-button" id="htmlSettingsBtn" aria-label="HTML panel settings">‚öô</button>
                    <div class="panel-settings-menu" id="htmlSettingsMenu">
                        <div class="more-option-item" id="htmlLibrariesBtn">
                            Add libraries
                        </div>
                        <div class="more-option-item" id="htmlTemplatesBtn">
                            Load starter template
                        </div>
                        <div class="more-option-item" id="htmlTestTemplatesBtn">
                            Load testing template
                        </div>
                        <div class="more-option-item" id="htmlFormatBtn">
                            Format code
                        </div>
                        <div class="more-option-item" id="htmlWrapToggle">
                            <span>Word wrap</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="htmlWrapCheckbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="editor-container">
                    <div class="line-numbers" id="htmlLineNumbers">1</div>
                    <div class="editor-content">
                        <div class="editor-highlight" id="htmlHighlight"></div>
                        <textarea
                            class="editor"
                            id="htmlEditor"
                            placeholder="<!-- Enter your HTML here -->"
                            spellcheck="false"
                            aria-label="HTML code editor. Press Tab to indent, Shift+Tab to outdent, Escape to exit and restore normal tab navigation."
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="editor-panel">
                <div class="editor-header">
                    <span>CSS</span>
                    <button class="panel-settings-button" id="cssSettingsBtn" aria-label="CSS panel settings">‚öô</button>
                    <div class="panel-settings-menu" id="cssSettingsMenu">
                        <div class="more-option-item" id="cssLibrariesBtn">
                            Add libraries
                        </div>
                        <div class="more-option-item" id="cssTemplatesBtn">
                            Load starter template
                        </div>
                        <div class="more-option-item" id="cssTestTemplatesBtn">
                            Load testing template
                        </div>
                        <div class="more-option-item" id="cssFormatBtn">
                            Format code
                        </div>
                        <div class="more-option-item" id="cssWrapToggle">
                            <span>Word wrap</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="cssWrapCheckbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="more-option-item" id="cssResetBtn">
                            CSS Reset: <span id="cssResetStatus">None</span>
                        </div>
                    </div>
                </div>
                <div class="editor-container">
                    <div class="line-numbers" id="cssLineNumbers">1</div>
                    <div class="editor-content">
                        <div class="editor-highlight" id="cssHighlight"></div>
                        <textarea
                            class="editor"
                            id="cssEditor"
                            placeholder="/* Enter your CSS here */"
                            spellcheck="false"
                            aria-label="CSS code editor. Press Tab to indent, Shift+Tab to outdent, Escape to exit and restore normal tab navigation."
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="editor-panel">
                <div class="editor-header">
                    <span>JavaScript</span>
                    <button class="panel-settings-button" id="jsSettingsBtn" aria-label="JavaScript panel settings">‚öô</button>
                    <div class="panel-settings-menu" id="jsSettingsMenu">
                        <div class="more-option-item" id="jsLibrariesBtn">
                            Add libraries
                        </div>
                        <div class="more-option-item" id="jsTemplatesBtn">
                            Load starter template
                        </div>
                        <div class="more-option-item" id="jsFormatBtn">
                            Format code
                        </div>
                        <div class="more-option-item" id="jsWrapToggle">
                            <span>Word wrap</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="jsWrapCheckbox">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="editor-container">
                    <div class="line-numbers" id="jsLineNumbers">1</div>
                    <div class="editor-content">
                        <div class="editor-highlight" id="jsHighlight"></div>
                        <textarea
                            class="editor"
                            id="jsEditor"
                            placeholder="// Enter your JavaScript here"
                            spellcheck="false"
                            aria-label="JavaScript code editor. Press Tab to indent, Shift+Tab to outdent, Escape to exit and restore normal tab navigation."
                        ></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resizer -->
        <div class="resizer" id="resizer"></div>

        <!-- Preview Section -->
        <div class="preview-section">
            <div class="preview-header">
                <span>Preview</span>
                <div class="preview-actions">
                    <div class="device-buttons">
                        <button class="device-btn active" data-width="100%" title="Desktop view" aria-label="Desktop view" aria-pressed="true">
                            Desktop
                        </button>
                        <button class="device-btn" data-width="768" title="Tablet (768px)" aria-label="Tablet view, 768 pixels wide" aria-pressed="false">
                            Tablet
                        </button>
                        <button class="device-btn" data-width="375" title="Mobile (375px)" aria-label="Mobile view, 375 pixels wide" aria-pressed="false">
                            Mobile
                        </button>
                    </div>
                    <span class="viewport-size" id="viewportSize">100%</span>
                    <button class="panel-settings-button" id="toggleConsoleBtn" title="Toggle Console" aria-label="Toggle console" aria-expanded="false" aria-controls="consolePanel">
                        Console
                    </button>
                </div>
            </div>
            <div class="preview-container">
                <div class="preview-viewport" id="previewViewport">
                    <iframe id="preview" title="Code preview output" sandbox="allow-scripts allow-modals allow-same-origin"></iframe>
                    <div class="viewport-resize-handle" id="viewportResizeHandle"></div>
                </div>
                <div class="console-panel" id="consolePanel">
                    <div class="console-header">
                        <span>Console</span>
                        <button class="console-clear" id="clearConsoleBtn" title="Clear console">Clear</button>
                    </div>
                    <div class="console-output" id="consoleOutput"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prism.js (locally hosted) -->
    <script src="/coded/vendor/prism.min.js"></script>
    <script src="/coded/vendor/prism-markup.min.js"></script>
    <script src="/coded/vendor/prism-css.min.js"></script>
    <script src="/coded/vendor/prism-javascript.min.js"></script>

    <!-- Template functionality (templates are loaded dynamically) -->
    <script src="/coded/template-loader.js"></script>

    <script src="/coded/coded.js"></script>
</body>
</html>
